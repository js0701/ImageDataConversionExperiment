<html>
<body>
<div>
</div>
<div>
<canvas id="displayCanvas" width="960" height=2560"> </canvas>
</div>

<script>

var imgs = [];
var imageDatas = [];
var maxImageCount = 32;
var processedImageCount = 0;
var useImageDataExtension = true;
var intervalHandle = 0;
var processTime = 0;
var timeBegin = 0;
var timeEnd = 0;
var worker = null;


function updateTimeLabel()
{
   processTime += 1;
   document.getElementById("processedImageCountLabel").innerHTML = "Update " + processTime + "times";
}

function ProcessImages()
{

  imgs.length = 0;
  imageDatas.length = 0;
  processedImageCount = 0;
  processTime = 0;

  if(intervalHandle)
      clearInterval(intervalHandle);

  var canvas = document.getElementById('displayCanvas');
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

//  if(worker) worker.close();
  worker = new Worker("swap.js");
  worker.addEventListener('message',swapDone);

  timeBegin = Date.now();
  timeEnd = timeBegin;

//  var woker = new Worker('swapRGB.js');
//  worker.postMessage = worker.webkitPostMessage || worker.postMessage;

  intervalHandle = setInterval(updateTimeLabel, 100);

  for(var i=0; i< maxImageCount; i++)
  {
  var img = new Image();
  img.src = "rose" + i + ".jpg";
  img.onload = function() {
  DecodingImage(this, i);
  };
  imgs.push(img);
  }
}

function DecodingImage(img, index)
{
    //var img = document.getElementById("theimage");

    if(useImageDataExtension)
    {
    ImageData.createFromSource(img).then(
    function(imageData) {
       //data = imageData.data;
       console.log("We have got data");
	   imageDatas.push(imageData);
       SwapRGB(imageData, imageDatas.length-1);
    }, function(message)
    {
       console.log("Decoding failed as " + message);
    });
    }

    else
    {
      var canvas = document.getElementById('getCanvas');
      var ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      var imageData = ctx.getImageData( 0, 0, img.width, img.height);
	  imageDatas.push(imageData);
      SwapRGB(imageData, imageDatas.length-1);
    }
}

function swapDone(e)
{
   var index = e.data.index;
   if(typeof index != undefined)
   {
        processedImageCount++;
        if(processedImageCount == maxImageCount)
        {
             clearInterval(intervalHandle);
             interValHandle = 0;
        }

      processedData = imageDatas[index];
     // processedData.data = new Uint8ClampedArray(e.data.data);
      putImage(processedData, processedImageCount-1);

   }
   else
   {
     console.log("Swap Woker got error " + e.data);
   }
}

function SwapRGB(originData, index)
{
   worker.postMessage({data:originData.data.buffer, index:index}, [originData.data.buffer]);
}


function putImage(processedData, index)
{
   var canvas = document.getElementById('displayCanvas');
   //var xstart = index*240;

   //for(var i=0; i < maxImageCount; i++)
   //{
     var xstart = (index%4)*240;
	 var ystart = (Math.floor(index/4))*320;
	 //var processedData = imageDatas[i];
     canvas.getContext('2d').putImageData(processedData, xstart, ystart, 0, 0, 240, 320);
   //}

    if(processedImageCount == maxImageCount)
    {
       timeEnd = Date.now();
       document.getElementById("actualtime").innerHTML = "Process time " + (timeEnd - timeBegin) + " ms";
    }
}

var imageBlob;
var blobUrl;

function CapturePicture()
{
   var context = document.getElementById("displayCanvas").getContext('2d');
   var idata = context.getImageData(0, 0, 960, 320);
   idata.toBlob().then(
   function(blob) {
      imageBlob = blob;
      blobUrl = URL.createObjectURL(imageBlob);
      var img = document.getElementById("CapturedPicture");
      img.src = blobUrl;
   },
   function(msg) {
      console.log("ImageData to blog get failure " + msg);
   }
   );

}

function swithExtension()
{
   if(!useImageDataExtension)
       useImageDataExtension = true;
   else
       useImageDataExtension = false;
}

</script>

<div id="processedImageCountLabel" style="font-size:400%; position:fixed; left:0px; top:0px; color:#FF0000">
Update
</div>

<div>
<button onclick="ProcessImages()"> <h1> ProcessImages </h1>  </button>
<button onclick="swithExtension()"> <h1> SwitchExtension </h1>  </button>
<div id="actualtime"  style="color:#FF0000"> </div>
</div>

<div>
<img id="CapturedPicture" width="960", height="320">
</div>

<button type="button" onclick="CapturePicture()"><h1>CatpurePicture</h1></button>
</div>

<div>
<canvas id="getCanvas" width="960" height=640"> </canvas>
</div>

</body>
</html>
